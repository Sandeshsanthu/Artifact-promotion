name: promote
concurrency:
  group: promote-${{ github.event.inputs.source_env }}-${{ github.event.inputs.target_env }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      source_env:
        description: "Source environment (dev|qa)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
      target_env:
        description: "Target environment (qa|prod)"
        required: true
        default: "qa"
        type: choice
        options:
          - qa
          - prod
      manifest_root:
        description: "Manifests root folder (use '.' if none)"
        required: true
        default: "manifest-repo"

permissions:
  contents: write
  pull-requests: write

jobs:
  promote_by_git_change:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout manifests repo into ./manifest-repo
        uses: actions/checkout@v4
        with:
          repository: Sandeshsanthu/artifact-promotion-deployment
          ref: main
          path: manifest-repo
          token: ${{ secrets.GITOPS_PAT }}
          fetch-depth: 0

      - name: Install yq (mikefarah v4)
        run: |
          set -euo pipefail
          YQ_VERSION="v4.44.3"
          sudo curl -fsSL -o /usr/local/bin/yq \
            "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          yq --version
      
      - name: Validate allowed promotion path
        run: | 
           set -euo pipefail
           SRC="${{ github.event.inputs.source_env }}"
           TGT="${{ github.event.inputs.target_env }}"
           if [ "${SRC}" = "dev" ] && [ "${TGT}" = "qa" ]; then exit 0; fi
           if [ "${SRC}" = "qa" ] && [ "${TGT}" = "prod" ]; then exit 0; fi
           echo "${SRC}"
           echo "${TGT}"
           echo "Invalid promotion path: ${SRC} -> ${TGT}"
           echo "Allowed: dev->qa, qa->prod"
           exit 1

      - name: Read digest from source overlay
        id: read
        run: |
          set -euo pipefail
          SRC="${{ github.event.inputs.source_env }}"
          SRC_FILE="manifest-repo/overlays/${SRC}/kustomization.yaml"

          test -f "${SRC_FILE}" || (echo "Missing ${SRC_FILE}" && ls -R manifest-repo && exit 1)

          DIGEST="$(yq e -r '.images[] | select(.name=="app-image") | .digest' "${SRC_FILE}")"
          NEWNAME="$(yq e -r '.images[] | select(.name=="app-image") | .newName' "${SRC_FILE}")"

          [ -n "${DIGEST}" ] && [ "${DIGEST}" != "null" ] || (echo "No digest in ${SRC_FILE}" && exit 1)
          [ -n "${NEWNAME}" ] && [ "${NEWNAME}" != "null" ] || (echo "No newName in ${SRC_FILE}" && exit 1)

          DIGEST_SAFE="$(echo "${DIGEST}" | sed 's/[^a-zA-Z0-9._-]/_/g' | cut -c1-60)"
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"
          echo "newname=${NEWNAME}" >> "$GITHUB_OUTPUT"
          echo "digest_safe=${DIGEST_SAFE}" >> "$GITHUB_OUTPUT"

      - name: Write same digest into target overlay
        run: |
          # Code Generated by Sidekick is for learning and experimentation purposes only.
          set -euo pipefail
          TGT="${{ github.event.inputs.target_env }}"
          TGT_FILE="manifest-repo/overlays/${TGT}/kustomization.yaml"

          test -f "${TGT_FILE}" || (echo "Missing ${TGT_FILE}" && ls -R manifest-repo && exit 1)

          IMAGE_NAME="${{ steps.read.outputs.newname }}"
          NEW_DIGEST="${{ steps.read.outputs.digest }}"

          IMAGE_NAME="$IMAGE_NAME" NEW_DIGEST="$NEW_DIGEST" yq -i '
            (.images[] | select(.name=="app-image")) |=
              (.newName = strenv(IMAGE_NAME) |
               .digest  = strenv(NEW_DIGEST) |
               del(.newTag))
          ' "${TGT_FILE}"

          (cd manifest-repo && git diff -- "overlays/${TGT}/kustomization.yaml" || true)

      - name: Create PR in manifests repo
        uses: peter-evans/create-pull-request@v7
        with:
          path: manifest-repo
          token: ${{ secrets.GITOPS_PAT }}
          base: main
          title: "Promote ${{ github.event.inputs.source_env }} -> ${{ github.event.inputs.target_env }}"
          # branch: "promote/${{ github.event.inputs.source_env }}-to-${{ github.event.inputs.target_env }}/${{ steps.read.outputs.digest_safe }}"
          branch: "promote/${{ github.event.inputs.source_env }}-to-${{ github.event.inputs.target_env }}"
          commit-message: "Promote digest to ${{ github.event.inputs.target_env }}"
          add-paths: |
            overlays/${{ github.event.inputs.target_env }}/kustomization.yaml
            delete-branch: true







 